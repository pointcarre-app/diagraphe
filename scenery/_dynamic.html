<!DOCTYPE html>
<html lang="en" data-theme="anchor">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scenery : Dynamic Editor</title>

    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="../dependencies/google_fonts.css" />
    <link rel="stylesheet" href="../dependencies/open_dyslexic_regular.css" />
    <link rel="stylesheet" href="../dependencies/daisyui@5.css" />
    <link rel="stylesheet" href="../dependencies/daisyui@5themes.css" />

    <!-- Our CSS -->
    <link rel="stylesheet" href="../src/css/root.css" />
    <link rel="stylesheet" href="../src/css/daisyui-svg-theming.css" />
    <link rel="stylesheet" href="../src/css/global.css" />

    <!-- JavaScript Dependencies -->
    <script src="../dependencies/tailwindcssbrowser@4.js"></script>

    <!-- CodeMirror for JavaScript syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" />


    <style>
        .CodeMirror {
            height: 70vh;
        }
    </style>
  </head>

  <body class="bg-base-200">
    <div class="container mx-auto max-w-8xl p-4">
      <!-- Header -->
      <div class="mb-6">
        <h1 class="text-xl font-bold text-base-content mb-2">Diagraphe Dynamic Editor</h1>

      </div>
      <!-- Two Column Layout -->

      <!-- Demo Selector -->
      <div class="card bg-base-100 shadow-xl mb-6">
        <div class="card-body p-4">
          <h2 class="card-title text-lg mb-3">Quick Demos</h2>
          <div class="grid grid-cols-1 gap-2" id="demo-buttons">
            <!-- Demo buttons will be added here by JavaScript -->
          </div>
        </div>
      </div>


      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Left Column: Editor -->
        <div class="space-y-4">


          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-4">
              <h2 class="card-title text-lg mb-3">Configuration Editor</h2>
              <div class="border border-base-content/20 rounded-lg min-h-96" id="editor-container"></div>
            </div>
          </div>
        </div>

        <!-- Right Column: Preview -->
        <div class="space-y-4">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-4">
              <h2 class="card-title text-lg mb-3">Live Preview (padding: 1rem inside the border)</h2>
              <div class="min-h-96 border border-base-content rounded-lg p-4 bg-base-100" id="preview-container">
                <!-- Diagram will be rendered here -->
              </div>
              <div class="mt-3" id="error-display" style="display: none;">
                <div class="alert alert-error py-2 px-3 text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="stroke-current shrink-0 h-4 w-4"
                       fill="none"
                       viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span id="error-message"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Diagraphe Module -->
    <script type="module">
        import {
            Diagraphe
        } from '../src/diagraphe.js';
        import {
            baselineDiagrapheDemos
        } from './_baseline_diagraphe_demos.js';

        let editor;
        let currentDiagram;

        // Initialize CodeMirror Editor and Demo Buttons
        document.addEventListener('DOMContentLoaded', function() {
            // Create demo buttons for first 4 demos
            const demoButtonsContainer = document.getElementById('demo-buttons');
            const firstFourDemos = baselineDiagrapheDemos.slice(0, 4);

            firstFourDemos.forEach((demo, index) => {
                const button = document.createElement('button');
                button.className = 'btn btn-outline btn-sm w-full text-left justify-start';
                button.innerHTML = `
                    <span class="truncate">${demo.label}</span>
                `;
                button.title = demo.description;
                button.addEventListener('click', () => loadDemo(demo));
                demoButtonsContainer.appendChild(button);
            });

            // Initialize editor with first demo
            loadDemo(firstFourDemos[0]);
        });

        function loadDemo(demo) {
            const config = demo.config;

            // Initialize/update editor
            if (!editor) {
                editor = CodeMirror(document.getElementById('editor-container'), {
                    value: JSON.stringify(config, null, 2).replace(/"([^"]+)":/g, '$1:'),
                    mode: 'javascript',
                    theme: 'monokai',
                    lineNumbers: true,
                    autoCloseBrackets: true,
                    matchBrackets: true,
                    indentUnit: 2,
                    tabSize: 2,
                    lineWrapping: true,
                    fontSize: '14px'
                });

                // Auto-update on content change
                editor.on('change', function() {
                    debounce(updateDiagram, 500)();
                });
            } else {
                editor.setValue(JSON.stringify(config, null, 2).replace(/"([^"]+)":/g, '$1:'));
            }

            // Update diagram immediately
            updateDiagram();
        }

        // Debounce function to avoid too frequent updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function updateDiagram() {
            try {
                // Clear previous diagram
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '';

                // Parse the editor content as JavaScript object
                const configText = editor.getValue();

                // Add 'const config = ' prefix and evaluate safely
                const fullCode = `const config = ${configText}; config;`;
                const config = eval(fullCode);

                // Validate required properties
                if (!config || typeof config !== 'object') {
                    throw new Error('Configuration must be an object');
                }


                // Add container to config
                config.container = previewContainer;

                // Create new diagram
                currentDiagram = new Diagraphe(config);

                // Hide error display
                document.getElementById('error-display').style.display = 'none';

            } catch (error) {
                console.error('Error rendering diagram:', error);

                // Show error message
                const errorDisplay = document.getElementById('error-display');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = `Error: ${error.message}`;
                errorDisplay.style.display = 'block';
            }
        }

        // Make functions available globally for debugging
        window.updateDiagram = updateDiagram;
        window.editor = editor;
    </script>
  </body>
</html>
