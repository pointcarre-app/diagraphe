<!DOCTYPE html>
<html lang="en" data-theme="anchor">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Scenery : Dynamic Editor</title>

    <!-- CSS Dependencies -->
    <link rel="stylesheet" href="../dependencies/google_fonts.css" />
    <link rel="stylesheet" href="../dependencies/open_dyslexic_regular.css" />
    <link rel="stylesheet" href="../dependencies/daisyui@5.css" />
    <link rel="stylesheet" href="../dependencies/daisyui@5themes.css" />

    <!-- Our CSS -->
    <link rel="stylesheet" href="../src/css/root.css" />
    <link rel="stylesheet" href="../src/css/daisyui-svg-theming.css" />
    <link rel="stylesheet" href="../src/css/global.css" />

    <!-- JavaScript Dependencies -->
    <script src="../dependencies/tailwindcssbrowser@4.js"></script>

    <!-- CodeMirror for JavaScript syntax highlighting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" />
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" />

    <style>
        .editor-container {
            height: 400px;
            border: 1px solid hsl(var(--bc) / 0.2);
            border-radius: 0.5rem;
        }

        .preview-container {
            min-height: 400px;
            border: 1px solid hsl(var(--bc) / 0.2);
            border-radius: 0.5rem;
            padding: 1rem;
            background: hsl(var(--b1));
        }
    </style>
  </head>

  <body class="bg-base-200">
    <div class="container mx-auto max-w-4xl p-4">
      <!-- Header -->
      <div class="mb-6">
        <h1 class="text-3xl font-bold text-base-content mb-2">Diagraphe Dynamic Editor</h1>
        <p class="text-base-content/70">Edit the configuration and see your diagram update in real-time</p>
      </div>

      <!-- Two Column Layout -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
        <!-- Left Column: Editor -->
        <div class="space-y-4">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-4">
              <h2 class="card-title text-lg mb-3">Configuration Editor</h2>
              <div class="editor-container" id="editor-container"></div>
              <div class="mt-3">
                <div class="alert alert-info py-2 px-3 text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       fill="none"
                       viewBox="0 0 24 24"
                       class="stroke-current shrink-0 w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z">
                    </path>
                  </svg>
                  <span>Edit the config object above - changes auto-update the diagram</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Right Column: Preview -->
        <div class="space-y-4">
          <div class="card bg-base-100 shadow-xl">
            <div class="card-body p-4">
              <h2 class="card-title text-lg mb-3">Live Preview</h2>
              <div class="preview-container" id="preview-container">
                <!-- Diagram will be rendered here -->
              </div>
              <div class="mt-3" id="error-display" style="display: none;">
                <div class="alert alert-error py-2 px-3 text-sm">
                  <svg xmlns="http://www.w3.org/2000/svg"
                       class="stroke-current shrink-0 h-4 w-4"
                       fill="none"
                       viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <span id="error-message"></span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Diagraphe Module -->
    <script type="module">
        import {
            Diagraphe,
            Element
        } from '../src/diagraphe.js';

        // Default configuration (same as first baseline demo)
        const defaultConfig = {
            width: 300,
            height: 200,
            margin: {
                top: 30,
                right: 40,
                bottom: 30,
                left: 40,
            },
            svg: {
                classes: ["bg-base-300"],
            },
            elements: [{
                classes: ["fill-primary"],
                width: 50,
                height: 50,
            }, ],
        };

        let editor;
        let currentDiagram;

        // Initialize CodeMirror Editor
        document.addEventListener('DOMContentLoaded', function() {
            editor = CodeMirror(document.getElementById('editor-container'), {
                value: JSON.stringify(defaultConfig, null, 2).replace(/"([^"]+)":/g, '$1:'),
                mode: 'javascript',
                theme: 'monokai',
                lineNumbers: true,
                autoCloseBrackets: true,
                matchBrackets: true,
                indentUnit: 2,
                tabSize: 2,
                lineWrapping: true,
                fontSize: '14px'
            });

            // Auto-update on content change
            editor.on('change', function() {
                debounce(updateDiagram, 500)();
            });

            // Initial render
            updateDiagram();
        });

        // Debounce function to avoid too frequent updates
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function updateDiagram() {
            try {
                // Clear previous diagram
                const previewContainer = document.getElementById('preview-container');
                previewContainer.innerHTML = '';

                // Parse the editor content as JavaScript object
                const configText = editor.getValue();

                // Add 'const config = ' prefix and evaluate safely
                const fullCode = `const config = ${configText}; config;`;
                const config = eval(fullCode);

                // Validate required properties
                if (!config || typeof config !== 'object') {
                    throw new Error('Configuration must be an object');
                }

                // Convert plain element objects to Element instances
                if (config.elements && Array.isArray(config.elements)) {
                    config.elements = config.elements.map(elementConfig => {
                        // If it's already an Element instance, keep it
                        if (elementConfig instanceof Element) {
                            return elementConfig;
                        }
                        // Otherwise, convert plain object to Element instance
                        return new Element(elementConfig);
                    });
                }

                // Add container to config
                config.container = previewContainer;

                // Create new diagram
                currentDiagram = new Diagraphe(config);

                // Hide error display
                document.getElementById('error-display').style.display = 'none';

            } catch (error) {
                console.error('Error rendering diagram:', error);

                // Show error message
                const errorDisplay = document.getElementById('error-display');
                const errorMessage = document.getElementById('error-message');
                errorMessage.textContent = `Error: ${error.message}`;
                errorDisplay.style.display = 'block';
            }
        }

        // Make functions available globally for debugging
        window.updateDiagram = updateDiagram;
        window.editor = editor;
    </script>
  </body>
</html>
